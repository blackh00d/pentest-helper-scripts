#!/bin/bash

# Function to display help text
display_help() {
    echo "Usage: $0 [TARGET] [-iL TARGET_LIST]"
    echo
    echo "Options:"
    echo "  TARGET        Single target IP or target range (e.g., 192.168.1.1 or 192.168.1.0/24)"
    echo "  -iL FILE      Input from list of hosts/networks"
    echo "  -h            Display this help text"
    exit 1
}

# Check if at least one argument is provided
if [ "$#" -eq 0 ]; then
    display_help
fi

# Function to check if masscan is installed
check_masscan() {
    if command -v masscan &> /dev/null; then
        return 0
    else
        return 1
    fi
}

# Function to perform initial TCP port scan using masscan
masscan_scan() {
    echo "Masscan detected. Using masscan for initial TCP scan..."
    sudo masscan $1 -p0-65535 --rate 10000 -oL /tmp/open-tcp-ports.txt
}

# Function to perform initial TCP port scan using nmap
nmap_tcp_scan() {
    echo "Masscan not detected. Using nmap for initial TCP scan..."
    nmap $1 -p- --open -T4 --max-retries=1 --min-rate=1000 -oN /tmp/open-tcp-ports.txt
}

# Function to perform initial UDP port scan using nmap
nmap_udp_scan() {
    echo "Checking for open UDP ports..."
    nmap -Pn -sU $1 -p U:7,11,13,19,37,53,69,123,137,138,161,177,285,500,523,1433,1434,1801,2512,2513,2598,2897,3527,5465 --open -T4 --max-retries=1 -oN /tmp/open-udp-ports.txt
}

# Function to extract open ports from scan results
extract_ports() {
    local file=$1
    ports=$(grep 'open' $file | cut -d'/' -f1 | sed ':a;N;$!ba;s/\n/,/g')
    echo $ports
}

# Function to perform a deep scan with nmap
deep_scan() {
    echo "The following TCP ports are open: $1"
    echo "Starting deep scan with nmap on TCP ports..."
    nmap $2 -p $1 -A --script="default and not intrusive" -oA deep_tcp_scan

    echo "The following UDP ports are open: $3"
    echo "Starting deep scan with nmap on UDP ports..."
    nmap $2 -sU -p U:$3 -A --script="default and not intrusive" -oA deep_udp_scan
}

# Main script logic
TARGET=""
TARGET_LIST=""

while [[ "$#" -gt 0 ]]; do
    case $1 in
        -h) display_help ;;
        -iL) TARGET_LIST=$2; shift ;;
        *) TARGET=$1 ;;
    esac
    shift
done

if [ -z "$TARGET" ] && [ -z "$TARGET_LIST" ]; then
    echo "Error: A target or target list must be specified."
    display_help
fi

if [ -n "$TARGET" ]; then
    SCAN_TARGET=$TARGET
elif [ -n "$TARGET_LIST" ]; then
    SCAN_TARGET="-iL $TARGET_LIST"
fi

# Initial scan to detect open TCP ports
if check_masscan; then
    masscan_scan $SCAN_TARGET
else
    nmap_tcp_scan $SCAN_TARGET
fi

# Extract open TCP ports
OPEN_TCP_PORTS=$(extract_ports /tmp/open-tcp-ports.txt)

if [ -z "$OPEN_TCP_PORTS" ]; then
    echo "No open TCP ports found."
fi

# Initial scan to detect open UDP ports
nmap_udp_scan $SCAN_TARGET

# Extract open UDP ports
OPEN_UDP_PORTS=$(extract_ports /tmp/open-udp-ports.txt)

if [ -z "$OPEN_UDP_PORTS" ]; then
    echo "No open UDP ports found."
fi

if [ -z "$OPEN_TCP_PORTS" ] && [ -z "$OPEN_UDP_PORTS" ]; then
    echo "No open ports found."
    exit 0
fi

# Deep scan to identify services and versions on open ports
deep_scan "$OPEN_TCP_PORTS" "$SCAN_TARGET" "$OPEN_UDP_PORTS"

echo "Scan complete. Results saved to deep_tcp_scan.* and deep_udp_scan.* files."
